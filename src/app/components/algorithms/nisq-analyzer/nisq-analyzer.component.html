<mat-card class="m-2">
  <div class="mx-3 mb-2">
    <mat-horizontal-stepper
      [linear]="true"
      #stepper="matHorizontalStepper"
    >
      <mat-step [editable]="true" label="Input">
        <h3>Analysis Jobs</h3>
        <div class="btn-wrapper">
          <button
                  mat-raised-button
                  type="Analysis"
                  color="primary"
                  (click)="onAddAnalysis()"
          >
            New Analysis
          </button>
        </div>
        <table
                mat-table
                [dataSource]="analyzerJobs$ | async"
                matSort
                multiTemplateDataRows
                (matSortChange)="changeSort($event.active, $event.direction)"
        >
          <ng-container matColumnDef="inputParameters">
            <th mat-header-cell *matHeaderCellDef>
              Input
            </th>
            <td mat-cell *matCellDef="let element">
              {{ formatParameters(element) }}
            </td>
          </ng-container>

          <ng-container matColumnDef="time">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Time
            </th>
            <td mat-cell *matCellDef="let element">
              {{ element.time }}
            </td>
          </ng-container>

          <ng-container matColumnDef="ready">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Readiness
            </th>
            <td mat-cell *matCellDef="let element">
              <button
                      mat-raised-button
                      *ngIf="element.ready"
                      type="button"
                      color="accent"
                      (click)="showAnalysisResult(element) && stepper.next()"
              >
                Show analysis
              </button>
              <div class="not-ready-attribute" *ngIf="!element.ready">
                not yet ready
              </div>
            </td>
          </ng-container>

          <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
          <ng-container matColumnDef="expandedDetail">
            <td
                    mat-cell
                    *matCellDef="let element"
                    [attr.colspan]="jobColumns.length"
            >
              <div
                      class="element-detail"
                      [@detailExpand]="
                      element == expandedElement ? 'expanded' : 'collapsed'
                    "
              >
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="jobColumns"></tr>
          <tr
                  mat-row
                  *matRowDef="let element; columns: jobColumns"
                  class="element-row"
                  [class.example-expanded-row]="expandedElement === element"
                  (click)="
                  expandedElement = expandedElement === element ? null : element
                "
          ></tr>
          <tr
                  mat-row
                  *matRowDef="let row; columns: ['expandedDetail']"
                  class="detail-row"
          ></tr>

        </table>
      </mat-step>

      <mat-step [editable]="true" label="Analyzer Results">
        <div class="btn-wrapper">
          <button
                  mat-raised-button
                  type="Back"
                  color="accent"
                  (click)="stepper.previous()"
          >
            Back
          </button>
        </div>
        <div *ngIf="analyzerJob">
        <div
                *ngFor="
                let resParam of filterInputParams(
                  analyzerJob.inputParameters
                ) | keyvalue
              "
        >
          <h3>Analysis Job from {{ analyzerJob.time }}, Input: {{ resParam.key }} = {{ resParam.value }}</h3>
        </div>
        </div>
        <div
          *ngIf="jobReady && analyzerResults && analyzerResults.length === 0"
          class="d-flex align-content-center justify-content-center py-5"
        >
          No suitable implementation and/or QPU found!
        </div>
        <ng-container *ngIf="jobReady && analyzerResults && analyzerResults.length !== 0">
          <div
            class="p-2 overflow-auto"
            *ngFor="let result of groupResultsByImplementation(analyzerResults)"
          >
            <h4>{{ result.implementation.name }}</h4>
            <table mat-table [dataSource]="result.results" multiTemplateDataRows>
              <ng-container matColumnDef="backendName">
                <th class="backend-column" mat-header-cell *matHeaderCellDef>
                  Backend Name
                </th>
                <td class="backend-column" mat-cell *matCellDef="let element">
                  <strong>{{ element.qpu }}</strong> (Queue length: {{queueLengths[element.qpu]}})
                </td>
              </ng-container>

              <ng-container matColumnDef="width">
                <th class="value-column" mat-header-cell *matHeaderCellDef>
                  Width
                </th>
                <td class="value-column" mat-cell *matCellDef="let element">
                  {{ element.analyzedWidth }}
                </td>
              </ng-container>

              <ng-container matColumnDef="depth">
                <th class="value-column" mat-header-cell *matHeaderCellDef>
                  Depth
                </th>
                <td class="value-column" mat-cell *matCellDef="let element">
                  {{ element.analyzedDepth }}
                </td>
              </ng-container>

              <ng-container matColumnDef="execution">
                <th class="action-column" mat-header-cell *matHeaderCellDef></th>
                <td class="action-column" mat-cell *matCellDef="let element">
                  <button
                    class="btn"
                    type="button"
                    (click)="execute(element); stepper.next()"
                  >
                    Execute
                  </button>
                </td>
              </ng-container>

              <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
              <ng-container matColumnDef="expandedDetail">
                <td
                  mat-cell
                  *matCellDef="let element"
                  [attr.colspan]="analyzeColumns.length"
                >
                  <div class="element-detail"
                       [@detailExpand]="
                      element == expandedElement ? 'expanded' : 'collapsed'
                    "
                  >
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="analyzeColumns"></tr>
              <tr
                mat-row
                *matRowDef="let element; columns: analyzeColumns"
                class="element-row"
                [class.example-expanded-row]="expandedElement === element"
                (click)="expandedElement = expandedElement === element ? null : element"
              ></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: ['expandedDetail']"
                class="detail-row"
              ></tr>
            </table>
          </div>
        </ng-container>
      </mat-step>

      <mat-step [editable]="true" label="Execution Results">
        <div
          *ngIf="!results"
          class="d-flex align-content-center justify-content-center"
        >
          <mat-spinner></mat-spinner>
        </div>
        <div *ngIf="results">
          <h3>Execution results</h3>
          <div class="p-2">
            <h6>Input</h6>
            <div
              *ngFor="
                let resParam of filterInputParams(
                  executedAnalyseResult.inputParameters
                ) | keyvalue
              "
            >
              <span>{{ resParam.key }}:</span>
              <span>{{ resParam.value }}</span>
            </div>
          </div>
          <div class="p-2 overflow-auto">
            <h5>Implementation: {{ executedAnalyseResult.implementation.name }}</h5>
            <table
              mat-table
              [dataSource]="[executedAnalyseResult]"
              multiTemplateDataRows
            >
              <ng-container matColumnDef="backendName">
                <th class="backend-column" mat-header-cell *matHeaderCellDef>
                  Backend Name
                </th>
                <td class="backend-column" mat-cell *matCellDef="let element">
                  {{ executedAnalyseResult.qpu }}
                </td>
              </ng-container>

              <ng-container matColumnDef="width">
                <th class="value-column" mat-header-cell *matHeaderCellDef>
                  Width
                </th>
                <td class="value-column" mat-cell *matCellDef="let element">
                  {{ executedAnalyseResult.analyzedWidth }}
                </td>
              </ng-container>

              <ng-container matColumnDef="depth">
                <th class="value-column" mat-header-cell *matHeaderCellDef>
                  Depth
                </th>
                <td class="value-column" mat-cell *matCellDef="let element">
                  {{ executedAnalyseResult.analyzedDepth }}
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="resultBackendColumns"></tr>
              <tr
                mat-row
                *matRowDef="let element; columns: resultBackendColumns"
                class="element-row"
              ></tr>
            </table>
          </div>
          <div class="p-2">
            <h5>Outcome</h5>
            <div>Status: {{ results.status }}</div>
            <code>{{ beautifyResult(results.result) }}</code>
          </div>
        </div>
      </mat-step>
    </mat-horizontal-stepper>
  </div>
</mat-card>
